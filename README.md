# Azure Machine Learning - Packaging models for deployment outside Azure Machine Learning

This sample demonstrates how to [package and deploy models outside Azure Machine Learning](https://learn.microsoft.com/en-us/azure/machine-learning/how-to-package-models-app-service?view=azureml-api-2&tabs=sdk) including the necessary Bicep to setup an Azure Machine Learning workspace environment.

This approach allows you to take the packaged model and deploy it to any environment that supports Docker containers outside the scope of Azure Machine Learning. This includes Azure Container Apps, Kubernetes, or an on-premises machine.

## Components

The [Bicep template](./infra/main.bicep) deploys the following resources to a subscription of your choice:

- [**Azure Machine Learning Workspace**](https://learn.microsoft.com/en-us/azure/machine-learning/overview-what-is-azure-machine-learning?view=azureml-api-2), a centralized place for data scientists and engineers to work with the data, prepare data, train, deploy, and manage models.
- [**Azure Machine Learning Computer Instance**](https://docs.microsoft.com/en-us/azure/machine-learning/concept-compute-instance), a managed cloud-based virtual machine with a Jupyter environment for the user.
  - The VM is configured with the following:
    - **VM Size**: Standard_E4ds_v4
    - **Idle time before shutdown**: 15 minutes
    - **Scheduled shutdown**: 6pm every day
    - **Creation script**: [`./src/setup/setup.sh`](./src/setup/setup.sh) to update to the latest Azure ML SDK v2 library in the conda environment.
- [**Azure Container Registry**](https://learn.microsoft.com/en-us/azure/container-registry/container-registry-intro), a private Docker registry for storing the container images.
- [**Azure Storage Account**](https://learn.microsoft.com/en-us/azure/storage/common/storage-account-overview), a general-purpose storage account for storing the Azure Machine Learning artifacts, logs, and datasets.
- [**Azure Key Vault**](https://learn.microsoft.com/en-us/azure/key-vault/key-vault-overview), a managed service that can store the secrets that can be used by the Azure Machine Learning workspace, for example, database connection strings such as Snowflake.
  - For more information, see [Authentication Secrets - Azure Machine Learning](https://learn.microsoft.com/en-us/azure/machine-learning/how-to-use-secrets-in-runs?view=azureml-api-2)
- [**Azure Log Analytics Workspace**](https://docs.microsoft.com/en-us/azure/azure-monitor/learn/quick-create-workspace), a workspace for storing the logs generated by the Azure Machine Learning workspace, including managed endpoints.
- [**Azure Managed Identity**](https://learn.microsoft.com/en-us/entra/identity/managed-identities-azure-resources/overview), a user-defined managed identity for the Machine Learning Workspace to access dependent resources.

## Getting Started

To deploy the infrastructure and get started with the [`src\Run.ipynb`](./src/Run.ipynb) notebook, you need to:

### Prerequisites

- Install [**PowerShell Core**](https://docs.microsoft.com/en-us/powershell/scripting/install/installing-powershell?view=powershell-7.1).
- Install the [**Azure CLI**](https://docs.microsoft.com/en-us/cli/azure/install-azure-cli).

### Deploy the infrastructure

The [components](#components) section above describes the resources that will be deployed.

The deployment occurs at the subscription level, creating a new resource group. The location of the deployment is set to **UK South** and this can be changed, as well as other parameters, in the [`./infra/main.bicepparam`](./infra/main.bicepparam) file.

**You must update or remove the `computeInstanceUsers` parameter to include your Azure AD user object ID from your tenant.** If you wish to add multiple users, the parameter is an array and you can include more. This will deploy the same configuration detailed in the components section for the compute instance for each user.

1. Clone the repository.
2. Open a PowerShell terminal at the root of the repository.
3. Run the following command to deploy the infrastructure (replacing any parameters as needed):

```powershell
az deployment sub create --name 'machinelearning' --location uksouth --template-file ./infra/main.bicep --parameters ./infra/main.bicepparam
```

This may take up to 10 minutes to complete on the first run.

### Clone the repository to a compute instance

1. From the **Notebooks** tab in the Azure Machine Learning workspace, open the workspace in VS Code (Web).
2. Open a terminal in VS Code and clone this repository to the compute instance.
3. Open the [`./src/Run.ipynb`](./src/Run.ipynb) notebook to continue your journey with packaging and deploying models outside Azure Machine Learning.
